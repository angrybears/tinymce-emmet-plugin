<!DOCTYPE html>
<html>
<head>
	<title>Emmet for TinyMCE</title>
	<link rel="stylesheet" href="css/codemirror.min.css">
</head>
<body>
	<form>
		<textarea id="code" name="code" autofocus></textarea>
	</form>
	<script src="js/cm3/codemirror.js"></script>
	<script src="js/cm3/xml.js"></script>
	<script src="js/emmet/emmet-full.min.js"></script>
	<script src="js/emmet/editor.js"></script>
	<script src="js/formatting.js"></script>
	<script>
		var target = document.getElementById('code'),
			editor = window.parent.tinymce.activeEditor,
			cm;

			target.value = editor.getContent({format : 'raw'});

			cm = CodeMirror.fromTextArea(target, {
				mode : 'text/html',
				lineNumbers : true,
				indentWithTabs: true,
				autofocus: true
			});

		CodeMirror.commands['selectAll'](cm);
      
		function getSelectedRange() {
			return { from: cm.getCursor(true), to: cm.getCursor(false) };
		}

		function autoFormatSelection() {
			var range = getSelectedRange();
			cm.autoFormatRange(range.from, range.to);
		}

		function commentSelection(isComment) {
			var range = getSelectedRange();
			cm.commentRange(isComment, range.from, range.to);
		}

		autoFormatSelection();

		// Save content
		cm.on('change', function (cm) {
			editor.setContent( cm.getTextArea().value );
			editor.nodeChanged();
			cm.save();
		});

		// For some reason calling setContent onchange is not enough
		// with this listener we make sure that every rule of code will be send back to tinycme
		cm.on('blur', function (cm) {
			editor.setContent( cm.getTextArea().value );
			editor.nodeChanged();
			cm.save();
		});
	</script>
</body>
</html>